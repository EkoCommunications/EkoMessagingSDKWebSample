'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.default = function () {
  return {
    visitor: {
      [importAndExport](astPath, astState) {
        if (!astPath.node.source) {
          return;
        }

        const importedPath = astPath.node.source.value;
        const sourceFilePath = astState.file.opts.filename;

        let myLinksFilePath = '';
        let myLinks = {};

        if (isLocalPackagePath(importedPath)) {
          return;
        }

        try {
          const {
            path: packageJsonPath,
            data: packageJson
          } = (0, _findNearestPackageJson.findNearestPackageJsonSync)(sourceFilePath);

          myLinksFilePath = (0, _findNearestPackageJson.findNearestPackageJsonSync)(sourceFilePath).path.replace('package.json', '.myLinks');

          myLinks = readMyLinksFile(myLinksFilePath);

          const localDependencies = readLocalDependencies(packageJson, myLinks);
          const projectPath = path.dirname(packageJsonPath);
          const importedModuleName = importedPath.split(path.sep)[0];

          if (!(importedModuleName in localDependencies)) {
            return;
          }

          const importedModuleRootPath = localDependencies[importedModuleName];
          const importedPathRelativeToProjectPath = path.join(importedModuleRootPath, ...importedPath.split(path.sep).slice(1));

          astPath.node.source.value = resolveRelativePath(path.dirname(sourceFilePath), path.join(projectPath, importedPathRelativeToProjectPath));
        } catch (error) {}
      }
    }
  };
};

var _path = require('path');

var path = _interopRequireWildcard(_path);

var _findNearestPackageJson = require('find-nearest-package-json');

var _fs = require('fs');

var fs = _interopRequireWildcard(_fs);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

const importAndExport = 'ImportDeclaration|ExportAllDeclaration|ExportNamedDeclaration';

function isLocalPackagePath(versionOrUrlOrPath) {
  return ['file:', 'link:', '../', './', '~/', '/'].some(prefix => versionOrUrlOrPath.startsWith(prefix));
}

function readMyLinksFile(myLinksFilePath) {
  try {
    return JSON.parse(fs.readFileSync(myLinksFilePath, { encoding: 'utf8' })).links;
  } catch (err) {
    return {};
  }
}

function readLocalDependencies(packageJson, myLinksFile) {
  const dependencies = _extends({}, packageJson.dependencies, packageJson.devDependencies);

  return Object.keys(dependencies).reduce((localDependencies, name) => {
    if (myLinksFile[name] && isLocalPackagePath(myLinksFile[name])) {
      dependencies[name] = myLinksFile[name];
    }
    return isLocalPackagePath(dependencies[name]) ? _extends({}, localDependencies, {
      [name]: parseLocalPackagePath(dependencies[name])
    }) : localDependencies;
  }, {});
}

function parseLocalPackagePath(localPackagePath) {
  return localPackagePath.replace(/^.*?:/, '');
}

function resolveRelativePath(fromPath, toPath) {
  const relativePath = path.relative(fromPath, toPath);

  if (relativePath === '') {
    return '.';
  }

  if (relativePath === '..') {
    return '..';
  }

  return `.${path.sep}${relativePath}`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbInZpc2l0b3IiLCJpbXBvcnRBbmRFeHBvcnQiLCJhc3RQYXRoIiwiYXN0U3RhdGUiLCJub2RlIiwic291cmNlIiwiaW1wb3J0ZWRQYXRoIiwidmFsdWUiLCJzb3VyY2VGaWxlUGF0aCIsImZpbGUiLCJvcHRzIiwiZmlsZW5hbWUiLCJteUxpbmtzRmlsZVBhdGgiLCJteUxpbmtzIiwiaXNMb2NhbFBhY2thZ2VQYXRoIiwicGF0aCIsInBhY2thZ2VKc29uUGF0aCIsImRhdGEiLCJwYWNrYWdlSnNvbiIsInJlcGxhY2UiLCJyZWFkTXlMaW5rc0ZpbGUiLCJsb2NhbERlcGVuZGVuY2llcyIsInJlYWRMb2NhbERlcGVuZGVuY2llcyIsInByb2plY3RQYXRoIiwiZGlybmFtZSIsImltcG9ydGVkTW9kdWxlTmFtZSIsInNwbGl0Iiwic2VwIiwiaW1wb3J0ZWRNb2R1bGVSb290UGF0aCIsImltcG9ydGVkUGF0aFJlbGF0aXZlVG9Qcm9qZWN0UGF0aCIsImpvaW4iLCJzbGljZSIsInJlc29sdmVSZWxhdGl2ZVBhdGgiLCJlcnJvciIsImZzIiwidmVyc2lvbk9yVXJsT3JQYXRoIiwic29tZSIsInByZWZpeCIsInN0YXJ0c1dpdGgiLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZVN5bmMiLCJlbmNvZGluZyIsImxpbmtzIiwiZXJyIiwibXlMaW5rc0ZpbGUiLCJkZXBlbmRlbmNpZXMiLCJkZXZEZXBlbmRlbmNpZXMiLCJPYmplY3QiLCJrZXlzIiwicmVkdWNlIiwibmFtZSIsInBhcnNlTG9jYWxQYWNrYWdlUGF0aCIsImxvY2FsUGFja2FnZVBhdGgiLCJmcm9tUGF0aCIsInRvUGF0aCIsInJlbGF0aXZlUGF0aCIsInJlbGF0aXZlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztrQkF3QmUsWUFBVztBQUN4QixTQUFPO0FBQ0xBLGFBQVM7QUFDUCxPQUFDQyxlQUFELEVBQWtCQyxPQUFsQixFQUFvQ0MsUUFBcEMsRUFBd0Q7QUFDdEQsWUFBSSxD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WixDQUFyQjtBQUNEO0FBQ0QsV0FBT3JDLG1CQUFtQmdDLGFBQWFLLElBQWIsQ0FBbkIsaUJBRUU5QixpQkFGRjtBQUdELE9BQUM4QixJQUFELEdBQVFDLHNCQUFzQk4sYUFBYUssSUFBYixDQUF0QjtBQUhQLFNBS0g5QixpQkFMSjtBQU1ELEdBVk0sRUFVSixFQVZJLENBQVA7QUFXRDs7QUFFRCxTQUFTK0IscUJBQVQsQ0FBK0JDLGdCQUEvQixFQUFpRTtBQUMvRCxTQUFPQSxpQkFBaUJsQyxPQUFqQixDQUF5QixPQUF6QixFQUFrQyxFQUFsQyxDQUFQO0FBQ0Q7O0FBRUQsU0FBU2EsbUJBQVQsQ0FBNkJzQixRQUE3QixFQUErQ0MsTUFBL0MsRUFBK0Q7QUFDN0QsUUFBTUMsZUFBZXpDLEtBQUswQyxRQUFMLENBQWNILFFBQWQsRUFBd0JDLE1BQXhCLENBQXJCOztBQUVBLE1BQUlDLGlCQUFpQixFQUFyQixFQUF5QjtBQUN2QixXQUFPLEdBQVA7QUFDRDs7QUFFRCxNQUFJQSxpQkFBaUIsSUFBckIsRUFBMkI7QUFDekIsV0FBTyxJQUFQO0FBQ0Q7O0FBRUQsU0FBUSxJQUFHekMsS0FBS1ksR0FBSSxHQUFFNkIsWUFBYSxFQUFuQztBQUNEIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogQGZsb3cgKi9cbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCB7IGZpbmROZWFyZXN0UGFja2FnZUpzb25TeW5jIH0gZnJvbSAnZmluZC1uZWFyZXN0LXBhY2thZ2UtanNvbidcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJ1xuXG50eXBlIEFzdFBhdGggPSB7XG4gIG5vZGU6IHtcbiAgICBzb3VyY2U6IHtcbiAgICAgIHZhbHVlOiBzdHJpbmdcbiAgICB9XG4gIH1cbn1cblxudHlwZSBBc3RTdGF0ZSA9IHtcbiAgZmlsZToge1xuICAgIG9wdHM6IHtcbiAgICAgIGZpbGVuYW1lOiBzdHJpbmdcbiAgICB9XG4gIH1cbn1cblxuY29uc3QgaW1wb3J0QW5kRXhwb3J0ID1cbiAgJ0ltcG9ydERlY2xhcmF0aW9ufEV4cG9ydEFsbERlY2xhcmF0aW9ufEV4cG9ydE5hbWVkRGVjbGFyYXRpb24nXG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKCkge1xuICByZXR1cm4ge1xuICAgIHZpc2l0b3I6IHtcbiAgICAgIFtpbXBvcnRBbmRFeHBvcnRdKGFzdFBhdGg6IEFzdFBhdGgsIGFzdFN0YXRlOiBBc3RTdGF0ZSkge1xuICAgICAgICBpZiAoIWFzdFBhdGgubm9kZS5zb3VyY2UpIHtcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGltcG9ydGVkUGF0aCA9IGFzdFBhdGgubm9kZS5zb3VyY2UudmFsdWVcbiAgICAgICAgY29uc3Qgc291cmNlRmlsZVBhdGggPSBhc3RTdGF0ZS5maWxlLm9wdHMuZmlsZW5hbWVcblxuICAgICAgICBsZXQgbXlMaW5rc0ZpbGVQYXRoID0gJydcbiAgICAgICAgbGV0IG15TGlua3MgPSB7fVxuXG4gICAgICAgIGlmIChpc0xvY2FsUGFja2FnZVBhdGgoaW1wb3J0ZWRQYXRoKSkge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBwYXRoOiBwYWNrYWdlSnNvblBhdGgsXG4gICAgICAgICAgICBkYXRhOiBwYWNrYWdlSnNvblxuICAgICAgICAgIH0gPSBmaW5kTmVhcmVzdFBhY2thZ2VKc29uU3luYyhzb3VyY2VGaWxlUGF0aClcblxuICAgICAgICAgIG15TGlua3NGaWxlUGF0aCA9IGZpbmROZWFyZXN0UGFja2FnZUpzb25TeW5jKFxuICAgICAgICAgICAgc291cmNlRmlsZVBhdGhcbiAgICAgICAgICApLnBhdGgucmVwbGFjZSgncGFja2FnZS5qc29uJywgJy5teUxpbmtzJylcblxuICAgICAgICAgIG15TGlua3MgPSByZWFkTXlMaW5rc0ZpbGUobXlMaW5rc0ZpbGVQYXRoKVxuXG4gICAgICAgICAgY29uc3QgbG9jYWxEZXBlbmRlbmNpZXMgPSByZWFkTG9jYWxEZXBlbmRlbmNpZXMocGFja2FnZUpzb24sIG15TGlua3MpXG4gICAgICAgICAgY29uc3QgcHJvamVjdFBhdGggPSBwYXRoLmRpcm5hbWUocGFja2FnZUpzb25QYXRoKVxuICAgICAgICAgIGNvbnN0IGltcG9ydGVkTW9kdWxlTmFtZSA9IGltcG9ydGVkUGF0aC5zcGxpdChwYXRoLnNlcClbMF1cblxuICAgICAgICAgIGlmICghKGltcG9ydGVkTW9kdWxlTmFtZSBpbiBsb2NhbERlcGVuZGVuY2llcykpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGltcG9ydGVkTW9kdWxlUm9vdFBhdGggPSBsb2NhbERlcGVuZGVuY2llc1tpbXBvcnRlZE1vZHVsZU5hbWVdXG4gICAgICAgICAgY29uc3QgaW1wb3J0ZWRQYXRoUmVsYXRpdmVUb1Byb2plY3RQYXRoID0gcGF0aC5qb2luKFxuICAgICAgICAgICAgaW1wb3J0ZWRNb2R1bGVSb290UGF0aCxcbiAgICAgICAgICAgIC4uLmltcG9ydGVkUGF0aC5zcGxpdChwYXRoLnNlcCkuc2xpY2UoMSlcbiAgICAgICAgICApXG5cbiAgICAgICAgICBhc3RQYXRoLm5vZGUuc291cmNlLnZhbHVlID0gcmVzb2x2ZVJlbGF0aXZlUGF0aChcbiAgICAgICAgICAgIHBhdGguZGlybmFtZShzb3VyY2VGaWxlUGF0aCksXG4gICAgICAgICAgICBwYXRoLmpvaW4ocHJvamVjdFBhdGgsIGltcG9ydGVkUGF0aFJlbGF0aXZlVG9Qcm9qZWN0UGF0aClcbiAgICAgICAgICApXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7fVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBpc0xvY2FsUGFja2FnZVBhdGgodmVyc2lvbk9yVXJsT3JQYXRoOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgcmV0dXJuIFsnZmlsZTonLCAnbGluazonLCAnLi4vJywgJy4vJywgJ34vJywgJy8nXS5zb21lKHByZWZpeCA9PlxuICAgIHZlcnNpb25PclVybE9yUGF0aC5zdGFydHNXaXRoKHByZWZpeClcbiAgKVxufVxuXG5mdW5jdGlvbiByZWFkTXlMaW5rc0ZpbGUobXlMaW5rc0ZpbGVQYXRoKTogeyBbc3RyaW5nXTogc3RyaW5nIH0ge1xuICB0cnkge1xuICAgIHJldHVybiBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhteUxpbmtzRmlsZVBhdGgsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KSlcbiAgICAgIC5saW5rc1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4ge31cbiAgfVxufVxuXG5mdW5jdGlvbiByZWFkTG9jYWxEZXBlbmRlbmNpZXMocGFja2FnZUpzb24sIG15TGlua3NGaWxlKTogeyBbc3RyaW5nXTogc3RyaW5nIH0ge1xuICBjb25zdCBkZXBlbmRlbmNpZXMgPSB7XG4gICAgLi4ucGFja2FnZUpzb24uZGVwZW5kZW5jaWVzLFxuICAgIC4uLnBhY2thZ2VKc29uLmRldkRlcGVuZGVuY2llc1xuICB9XG5cbiAgcmV0dXJuIE9iamVjdC5rZXlzKGRlcGVuZGVuY2llcykucmVkdWNlKChsb2NhbERlcGVuZGVuY2llcywgbmFtZSkgPT4ge1xuICAgIGlmIChteUxpbmtzRmlsZVtuYW1lXSAmJiBpc0xvY2FsUGFja2FnZVBhdGgobXlMaW5rc0ZpbGVbbmFtZV0pKSB7XG4gICAgICBkZXBlbmRlbmNpZXNbbmFtZV0gPSBteUxpbmtzRmlsZVtuYW1lXVxuICAgIH1cbiAgICByZXR1cm4gaXNMb2NhbFBhY2thZ2VQYXRoKGRlcGVuZGVuY2llc1tuYW1lXSlcbiAgICAgID8ge1xuICAgICAgICAgIC4uLmxvY2FsRGVwZW5kZW5jaWVzLFxuICAgICAgICAgIFtuYW1lXTogcGFyc2VMb2NhbFBhY2thZ2VQYXRoKGRlcGVuZGVuY2llc1tuYW1lXSlcbiAgICAgICAgfVxuICAgICAgOiBsb2NhbERlcGVuZGVuY2llc1xuICB9LCB7fSlcbn1cblxuZnVuY3Rpb24gcGFyc2VMb2NhbFBhY2thZ2VQYXRoKGxvY2FsUGFja2FnZVBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBsb2NhbFBhY2thZ2VQYXRoLnJlcGxhY2UoL14uKj86LywgJycpXG59XG5cbmZ1bmN0aW9uIHJlc29sdmVSZWxhdGl2ZVBhdGgoZnJvbVBhdGg6IHN0cmluZywgdG9QYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgcmVsYXRpdmVQYXRoID0gcGF0aC5yZWxhdGl2ZShmcm9tUGF0aCwgdG9QYXRoKVxuXG4gIGlmIChyZWxhdGl2ZVBhdGggPT09ICcnKSB7XG4gICAgcmV0dXJuICcuJ1xuICB9XG5cbiAgaWYgKHJlbGF0aXZlUGF0aCA9PT0gJy4uJykge1xuICAgIHJldHVybiAnLi4nXG4gIH1cblxuICByZXR1cm4gYC4ke3BhdGguc2VwfSR7cmVsYXRpdmVQYXRofWBcbn1cbiJdfQ==